{{- $values := .Values }}
{{- range $name, $pool := .Values.workers }}
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: {{ $.Values.global.clusterName }}-{{ $name }}
spec:
  template:
    spec:
      preKubeadmCommands:
        - echo debug-pre > /tmp/out
        - mkdir -p /etc/pre-kubeadm-commands
        - for script in $(find /etc/pre-kubeadm-commands/ -name '*.sh' -type f | sort);
          do echo "Running script $script"; "$script"; done
      postKubeadmCommands:
        - echo debug-post >> /tmp/out
        - mkdir -p /etc/post-kubeadm-commands
        - for script in $(find /etc/post-kubeadm-commands/ -name '*.sh' -type f | sort);
          do echo "Running script $script"; "$script"; done
      files:
      - content: |
          #!/bin/bash
          curl https://github.com/opencontainers/runc/releases/download/v1.1.1/runc.amd64 -Lo /tmp/runc.amd64
          chmod +x /tmp/runc.amd64
          cp -f /tmp/runc.amd64 /usr/local/sbin/runc
        owner: root:root
        path: /etc/pre-kubeadm-commands/10-set_runc.sh
        permissions: "0744"
      - content: |
          #!/bin/bash
          set +e
          # Define the retry function
          wait_and_retry() {
            local retries="$1"
            local wait="$2"
            local command="$3"

            $command
            local exit_code=$?

            if [[ $exit_code -ne 0 && $retries -gt 0 ]]; then
              echo "# Wait $wait before retrying $retries"
              sleep $wait
              wait_and_retry $(($retries - 1)) $wait "$command"
            else
              return $exit_code
            fi
          }
          endpoint=""
          [[ -f /run/kubeadm/kubeadm.yaml ]] && endpoint=$(grep "controlPlaneEndpoint" /run/kubeadm/kubeadm.yaml|awk ' {print $2 }' |sed -e 's/ //g;s/:.*//g')
          [[ -f  /run/kubeadm/kubeadm-join-config.yaml ]] && endpoint=$(grep "apiServerEndpoint" /run/kubeadm/kubeadm-join-config.yaml |awk ' {print $2 }' |sed -e 's/ //g;s/:.*//g')

          [[ -n "$endpoint" ]] &&wait_and_retry 360 10 "host $endpoint"
        owner: root:root
        path: /etc/pre-kubeadm-commands/00-wait_endpoint.sh
        permissions: "0755"
      joinConfiguration:
        nodeRegistration:
          imagePullPolicy: IfNotPresent
          name: {{`'{{ ds.meta_data.local_hostname }}'`}}
          kubeletExtraArgs:
            cloud-provider: external
            provider-id: {{`'aws:///{{ ds.meta_data.placement.availability_zone }}/{{ ds.meta_data.instance_id }}'`}}
            {{- with $pool.nodeLabels }}
            node-labels: "{{ range $i, $k := (keys . | sortAlpha) }}{{ if ne $i 0 }},{{ end }}{{ $k }}={{ index $pool.nodeLabels $k }}{{ end }}"
            {{- end }}
---
{{- end }}
